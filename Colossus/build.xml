<?xml version="1.0"?>

<!-- Ant buildfile for Colossus -->
<!-- $Id$ -->

<!-- To use this you need:
     Sun JDK 1.3+    http://java.sun.com  (currently recommend 1.4.0)
     Ant 1.4.1+      http://jakarta.apache.org/ant/
        with corresponding optional.jar installed in $ANT_HOME/lib
     JavaCC 2.1      http://www.webgain.com/trialware/javacc/JavaCC2_1.zip
        Environment var JAVACC_HOME pointing to JavaCC install root
     Javamake 1.2.8+ http://www.experimentalstuff.com/Technologies/JavaMake/
        javamake.jar needs to be in your CLASSPATH.
     JUnit 3.7       http://junit.org
        junit.jar AND the junit directory need to be in your CLASSPATH.
     To sign jarfiles, you need a file called usernameKeystore,
        (substituting your username for "username")
        with an alias matching your username, and you need to put
        the password for this key in environment var JARPASSWORD.
        (Ant won't do keyboard password input.)
     To make a ChangeLog file from cvs history, you need cvs2cl.pl
        http://www.red-bean.com/cvs2cl/  You also need perl in the path.
        And you need to have ssh-agent set up so that you can do cvs
        commands over ssh without password prompts.
     To build the docs you need:
        make
        LaTeX
        latex2html
        dvi2tty    http://www.mesa.nl/pub/dvi2tty/
-->

<project name="Colossus" default="jar" basedir=".">

<property environment="env"/>



<target name="init"
        description="Initialization">

        <tstamp/>

        <!-- Set this to jikes or kjc to use those instead of javac -->
        <property name="build.compiler" value="modern"/>



        <property name="HTMLDIR" value="/home/groups/c/co/colossus/htdocs"/>
        <property name="DOWNLOAD_DIR" value="${HTMLDIR}/download"/>
        <property name="DOCS_DIR" value="${HTMLDIR}/docs"/>
        <property name="ZIPFILE" value="Colossus.${DSTAMP}.zip"/>
        <property name="SERVER" value="shell1.sf.net"/>

</target>


<target name="version" depends="init"
        description="Create a timestamp file">
        <echo file="./version" message="${DSTAMP}&#10;"
        />
</target>


<!-- The javacc target does not support multiple .jj files in one target. -->
<target name="parsers" 
        depends="BattlelandLoader,
                 CreatureLoader,
                 StrategicMapLoader,
                 TerrainRecruitLoader,
                 VariantLoader,
                 BattlelandRandomizerLoader"
        description = "Create .java files from .jj files with javacc">
</target>

<target name="BattlelandLoader">
        <javacc target="net/sf/colossus/parser/BattlelandLoader.jj"
                javacchome="${env.JAVACC_HOME}"
        />
</target>

<target name="CreatureLoader">
        <javacc target="net/sf/colossus/parser/CreatureLoader.jj"
                javacchome="${env.JAVACC_HOME}"
        />
</target>

<target name="StrategicMapLoader">
        <javacc target="net/sf/colossus/parser/StrategicMapLoader.jj"
                javacchome="${env.JAVACC_HOME}"
        />
</target>

<target name="TerrainRecruitLoader">
        <javacc target="net/sf/colossus/parser/TerrainRecruitLoader.jj"
                javacchome="${env.JAVACC_HOME}"
        />
</target>

<target name="VariantLoader">
        <javacc target="net/sf/colossus/parser/VariantLoader.jj"
                javacchome="${env.JAVACC_HOME}"
        />
</target>

<target name="BattlelandRandomizerLoader">
        <javacc target="net/sf/colossus/parser/BattlelandRandomizerLoader.jj"
                javacchome="${env.JAVACC_HOME}"
        />
</target>


<!-- Delete stale jar files before compiling -->
<target name="cleanjars" depends=""
        description = "Delete stale jar files">
        <delete verbose="yes" quiet = "yes" file = "Colossus.jar"/>
        <delete verbose="yes" quiet = "yes" file = "test/Colossus.jar"/>
        <delete verbose="yes" quiet = "yes" file = "BattlelandsBuilder.jar"/>
        <delete verbose="yes" quiet = "yes" file = "BattlelandsRandomizer.jar"/>
</target>


<taskdef name="javamake" classname="com.sun.tools.javamake.ant.JavaMake"/>

<!-- TODO Find a way to switch between javamake and javac using a variable -->

<!-- If you don't have Javamake you can change "javamake" to "javac" --> 
<!-- But get Javamake instead.  Good dependency checking helps a lot. --> 
<target name="compile" depends="init,parsers,cleanjars"
        description = "Compile most .java files to .class files using javamake">
        <javamake debug="yes" deprecation="yes" target="1.3" srcdir="."
                includes="**/*.java"
                excludes="**/*Test.java"
        />
</target>

<!-- TODO Add an option to always compileAll based on an environment var. -->

<!-- If you don't have Javamake you can change "javamake" to "javac" --> 
<!-- But get Javamake instead.  Good dependency checking helps a lot. --> 
<target name="compileAll" depends="init,parsers,cleanjars"
        description = "Compile all .java files to .class files using javamake">
        <javamake debug="yes" deprecation="yes" target="1.3" srcdir="."
                includes="**/*.java"
        />
</target>


<!-- XXX Why does this fail if we set fork to yes? -->
<!-- TODO Add test suite. -->
<target name="test" depends="compileAll,jar"
        description = "Run all unit tests using JUnit">
        <junit printsummary="yes" fork="no" haltonfailure="no">
                <formatter type="plain"/>
                <test name="net.sf.colossus.server.BalancedTowersTest"/>
                <test name="net.sf.colossus.server.LOSTest"/>
                <test name="net.sf.colossus.server.CarryTest"/>
        </junit>
</target>

<!-- TODO Add GUI test task. -->

<target name="javadoc" depends="compile"
        description = "Make javadoc files">
        <mkdir dir="javadoc"/>
        <javadoc sourcepath="." destdir="./javadoc" access="private"
                 packagenames="net.sf.colossus.*"
        />
</target>


<!-- TODO If the jar is newer than all its contents, don't build. -->
<target name="jar" depends="init,compile,version"
        description = "Make jar file">
        <jar jarfile = "Colossus.jar" basedir="."
             manifest="META-INF/MANIFEST.MF"
             includes="**/*.class,
                       version,
                       Default/**,
                       TitanPlus/**,
                       ExtTitan/**,
                       Badlands/**,
                       Badlands-JDG/**,
                       Undead/**,
                       TG-SetII/**,
                       TG-SetIII/**,
                       TG-ConceptI/**,
                       TG-ConceptII/**,
                       TG-ConceptIII/**,
                       TG-Wild/**,
                       Outlands/**,
                       SmallTitan/**"
             excludes="net/sf/colossus/datatools/*.class,
                       **/*Test.class"
             />
        <chmod file="Colossus.jar" perm="755"/>
</target>



<!-- Be very careful modifying this.  It whacks whole directories easily. -->
<!-- XXX Files like .#Colossus.jar.1.203 are not being deleted.  Ant bug? -->
<target name="clean" depends="cleanjars"
        description = "Delete most derived files"> 
        <delete verbose="yes" quiet = "yes" includeemptydirs="yes"> 
                <fileset dir="." 
                 includes = 
                        "version,
                         log,
                         fixcrlf*,
                         **/core,
                         **/javacore.txt,
                         **/*~,
                         **/*.bak,
                         **/*.old,
                         **/*.class,
                         **/.#Colossus.jar*,
                         **/Colossus.*.zip,
                         TEST-*Test.txt,
                         javadoc/**,
                         docs/**/*.aux,
                         docs/**/*.log,
                         docs/**/*.toc,
                         docs/**/*.blg,
                         docs/**/*.bbl,
                         docs/**/*.dvi,
                         docs/**/*.ps,
                         docs/**/*.html,
                         docs/**/*.css,
                         docs/**/*.pl"
                />
        </delete>
</target>


<target name="fullyclean" depends="clean"
        description = "Delete all derived files and savegames"> 
        <delete verbose="yes" quiet = "yes" includeemptydirs="yes">
                <fileset dir="." 
                 includes = 
                         "net/sf/colossus/parser/*.java,
                          javamake.pdb,
                          **/*.sav"
                />
        </delete>
</target>


<target name="fix"
        description = "Fix end of line characters and eliminate tabs"> 
        <fixcrlf srcDir="." eol="lf" tab="remove" javafiles="yes" 
                eof="remove" tablength="8"
                includes="**/*.java,**/*.jj"
        />
</target>


<target name="run" depends="jar"
        description = "Run the game">
        <java jar="Colossus.jar"
              fork="yes"/>
</target>


<!-- Tools -->


<target name="tools" depends="bbjar,brjar"/>

<target name="bbjar" depends="init,compile,version"
        description = "Make Battlelands Builder jar file">
        <jar jarfile = "BattlelandsBuilder.jar" basedir="."
             manifest="META-INF/datatools/BattlelandsBuilder/MANIFEST.MF"
             includes="net/sf/colossus/datatools/*.class,
             net/sf/colossus/client/*.class,
             net/sf/colossus/parser/*.class,
             net/sf/colossus/server/*.class,
             net/sf/colossus/util/*.class,
             Default,
             TitanPlus,
             ExtTitan,
             Badlands,
             Sakis,
             Outlands"
        />
        <chmod file="BattlelandsBuilder.jar" perm="755"/>
</target>

<target name="brjar" depends="init,compile,version"
        description = "Make Battlelands Randomizer jar file">
        <jar jarfile = "BattlelandsRandomizer.jar" basedir="."
             manifest="META-INF/datatools/BattlelandsRandomizer/MANIFEST.MF"
             includes="net/sf/colossus/datatools/*.class,
             net/sf/colossus/client/*.class,
             net/sf/colossus/parser/*.class,
             net/sf/colossus/server/*.class,
             net/sf/colossus/util/*.class,
             Default,
             TitanPlus,
             ExtTitan,
             Badlands,
             Sakis,
             Outlands"
        />
        <chmod file="BattlelandsRandomizer.jar" perm="755"/>
</target>

<!-- TODO If jar is already signed, don't sign it again. -->
<target name="sign" depends="jar"
        description = "Sign jar file">
        <signjar jar="Colossus.jar"
                 alias="${user.name}"
                 keystore="${user.name}Keystore"
                 storepass="${env.JARPASSWORD}"
        />
        <chmod file="Colossus.jar" perm="755"/>
        <copy file="Colossus.jar" todir="test"/>
</target>



<!-- Tasks from here down are only needed for installation on the web site. -->

<!-- TODO Make a Windows version of this task. -->
<target name="changelog" depends=""
        description = "Create a ChangeLog file from cvs history">
        <exec executable="cvs2cl.pl" os="Linux,SunOS">
            <arg line="-S --no-wrap --utc"/>
        </exec>
        <delete verbose="yes" file = "ChangeLog.bak"/>
</target>

<target name="docs" depends=""
        description = "Generate docs from TeX source">
        <exec executable="make" dir="docs" os="Linux,SunOS">
            <arg line=""/>
        </exec>
</target>

<target name="dist" depends="init,sign,changelog,tools"
        description = "Make zip file for user download">
        <zip zipfile="${ZIPFILE}" basedir="."
             excludes="**/*.sav,
                 **/*.zip, 
                 **/*.bak, 
                 **/*javadoc*/*, 
                 *Keystore*,
                 *cfg,
                 *properties*,
                 BattlelandsBuilder.jar,
                 BattlelandsRandomizer.jar,
                 .*,
                 test/*.jar,
                 **/*.ps,
                 **/*.aux,
                 **/*.bbl,
                 **/*.bib,
                 **/*.blg,
                 **/*.log,
                 **/*.old"
        />
</target>


<target name="inst" depends="init,sign,dist,changelog,docs"
        description = "Locally copy files into htdocs tree on SF"> 
        <copy file="Colossus.jar" todir="${HTMLDIR}"/>
        <copy file="Colossus.jnlp" todir="${HTMLDIR}"/>
        <move file="${ZIPFILE}" todir="${DOWNLOAD_DIR}"/>
        <copy file="ChangeLog" todir="${HTMLDIR}"/>
        <copy todir="${DOCS_DIR}"> <fileset dir="docs"/></copy>
        <delete> 
                <fileset dir="${DOWNLOAD_DIR}" includes = "1_LATEST_IS_*"/> 
        </delete>
        <touch file="${DOWNLOAD_DIR}/1_LATEST_IS_${DSTAMP}"/>
</target>

<!-- TODO Eliminate double maintenance -->
<!-- This requires a good ssh-agent setup. -->
<target name="remote-inst" depends="init,sign,dist,changelog,docs"
        description = "scp files into htdocs tree on SF"> 
        <exec executable="scp">
            <arg line="Colossus.jar ${SERVER}:${HTMLDIR}"/>
        </exec>
        <exec executable="scp">
            <arg line="Colossus.jnlp ${SERVER}:${HTMLDIR}"/>
        </exec>
        <exec executable="scp">
            <arg line="${ZIPFILE} ${SERVER}:${DOWNLOAD_DIR}"/>
        </exec>
        <exec executable="ssh">
            <arg line="${SERVER} rm -r ${DOCS_DIR}"/>
        </exec>
        <exec executable="scp">
            <arg line="-pr docs/ ${SERVER}:${HTMLDIR}"/>
        </exec>
        <delete> 
                <fileset dir="${DOWNLOAD_DIR}" includes = "1_LATEST_IS_*"/> 
        </delete>
        <exec executable="ssh">
            <arg line="${SERVER} rm ${DOWNLOAD_DIR}/1_LATEST_IS_*"/>
        </exec>
        <touch file="${DOWNLOAD_DIR}/1_LATEST_IS_${DSTAMP}"/>
        <exec executable="scp"> 
            <arg line="${DOWNLOAD_DIR}/1_LATEST_IS_${DSTAMP} ${SERVER}:${DOWNLOAD_DIR}"/>
        </exec>
</target>


</project>
