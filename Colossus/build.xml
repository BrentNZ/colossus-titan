<?xml version="1.0"?>

<!-- Ant buildfile for Colossus -->
<!-- $Id$ -->

<!-- To use this you need:
     Sun JDK 1.3+  http://java.sun.com  (currently recommend 1.4.0)
     Ant 1.4.1+    http://jakarta.apache.org/ant/
        with corresponding optional.jar installed in $ANT_HOME/lib
     JavaCC 2.1    http://www.webgain.com/trialware/javacc/JavaCC2_1.zip
        Environment var JAVACC_HOME pointing to JavaCC install root
     Javamake      //http://www.experimentalstuff.com/Technologies/JavaMake/
     To sign jarfiles, you need a file called usernameKeystore,
        (substituting your username for "username")
        with an alias matching your username, and you need to put
        the password for this key in environment var JARPASSWORD.
        (Ant won't do keyboard password input.)
     To make a ChangeLog file from cvs history, you need cvs2cl.pl
        http://www.red-bean.com/cvs2cl/  You also need perl in the path.
        And you need to have ssh-agent set up so that you can do cvs
        commands over ssh without password prompts.
     To build the docs you need:
        make
        LaTeX
        latex2html
        dvi2tty    http://www.mesa.nl/pub/dvi2tty/
-->

<project name="Colossus" default="jar" basedir=".">

<property environment="env"/>



<target name="init"
        description="Initialization">

        <tstamp/>

        <!-- Set this to jikes or kjc to use those instead of javac -->
        <property name="build.compiler" value="modern"/>



        <property name="HTMLDIR" value="/home/groups/c/co/colossus/htdocs"/>
        <property name="DOWNLOAD_DIR" value="${HTMLDIR}/download"/>
        <property name="DOCS_DIR" value="${HTMLDIR}/docs"/>
        <property name="ZIPFILE" value="Colossus.${DSTAMP}.zip"/>

</target>


<target name="version" depends="init"
        description="Create a timestamp file">
        <echo file="./version" message="${DSTAMP}&#10;"
        />
</target>


<!-- The javacc target does not support multiple .jj files in one target. -->
<target name="parsers" 
        depends="BattlelandLoader,
                 CreatureLoader,
                 StrategicMapLoader,
                 TerrainRecruitLoader,
                 VariantLoader,
                 BattlelandRandomizerLoader"
        description = "Create .java files from .jj files with javacc">
</target>

<target name="BattlelandLoader">
        <javacc target="net/sf/colossus/parser/BattlelandLoader.jj"
                javacchome="${env.JAVACC_HOME}"
        />
</target>

<target name="CreatureLoader">
        <javacc target="net/sf/colossus/parser/CreatureLoader.jj"
                javacchome="${env.JAVACC_HOME}"
        />
</target>

<target name="StrategicMapLoader">
        <javacc target="net/sf/colossus/parser/StrategicMapLoader.jj"
                javacchome="${env.JAVACC_HOME}"
        />
</target>

<target name="TerrainRecruitLoader">
        <javacc target="net/sf/colossus/parser/TerrainRecruitLoader.jj"
                javacchome="${env.JAVACC_HOME}"
        />
</target>

<target name="VariantLoader">
        <javacc target="net/sf/colossus/parser/VariantLoader.jj"
                javacchome="${env.JAVACC_HOME}"
        />
</target>

<target name="BattlelandRandomizerLoader">
        <javacc target="net/sf/colossus/parser/BattlelandRandomizerLoader.jj"
                javacchome="${env.JAVACC_HOME}"
        />
</target>

<!-- XXX Ant's depend task is broken, so just delete all class files. -->
<target name="dep"
        description = "Delete dependant class files"> 
        <delete verbose="yes" quiet = "yes"> 
                <fileset dir="." 
                 includes = 
                         "**/*.class"
                />
        </delete>
</target>

<taskdef name="javamake" classname="com.sun.tools.javamake.ant.JavaMake"/>

<!-- Change "javamake" to "javac" in the task below if you want. -->
<target name="compile" depends="init,parsers"
        description = "Compile .java files to .class files using javamake">
        <delete verbose="yes" quiet = "yes" file = "Colossus.jar"/>
        <delete verbose="yes" quiet = "yes" file = "test/Colossus.jar"/>
        <delete verbose="yes" quiet = "yes" file = "BattlelandsBuilder.jar"/>
        <delete verbose="yes" quiet = "yes" file = "BattlelandsRandomizer.jar"/>
        <javamake debug="yes" deprecation="yes" target="1.2" srcdir="."
                includes="**/*.java"
        />
</target>



<target name="javadoc" depends="compile"
        description = "Make javadoc files">
        <mkdir dir="javadoc"/>
        <javadoc sourcepath="." destdir="./javadoc" access="private"
                 packagenames="net.sf.colossus.*"
        />
</target>


<!-- TODO If the jar is newer than all its contents, don't build. -->
<target name="jar" depends="init,compile,version"
        description = "Make jar file">
        <jar jarfile = "Colossus.jar" basedir="."
             manifest="META-INF/MANIFEST.MF"
             includes="**/*.class,
                       version,
                       Default/**,
                       TitanPlus/**,
                       ExtTitan/**,
                       Badlands/**,
                       Undead/**,
                       Outlands/**"
             excludes="net/sf/colossus/datatools/*.class"
             />
        <chmod file="Colossus.jar" perm="755"/>
</target>



<!-- Be very careful modifying this.  It whacks whole directories easily. -->
<!-- XXX Files like .#Colossus.jar.1.203 are not being deleted.  Ant bug? -->
<target name="clean"
        description = "Delete most derived files"> 
        <delete verbose="yes" quiet = "yes" includeemptydirs="yes"> 
                <fileset dir="." 
                 includes = 
                        "version,
                         fixcrlf*,
                         **/core,
                         **/javacore.txt,
                         **/*~,
                         **/*.bak,
                         **/*.old,
                         **/*.class,
                         **/Colossus.jar,
                         **/.#Colossus.jar*,
                         **/Colossus.*.zip,
                         javadoc/**,
                         docs/**/*.aux,
                         docs/**/*.log,
                         docs/**/*.toc,
                         docs/**/*.blg,
                         docs/**/*.bbl,
                         docs/**/*.dvi,
                         docs/**/*.ps,
                         docs/**/*.html,
                         docs/**/*.css,
                         docs/**/*.pl"
                />
        </delete>
</target>


<target name="fullyclean" depends="clean"
        description = "Delete all derived files and savegames"> 
        <delete verbose="yes" quiet = "yes" includeemptydirs="yes">
                <fileset dir="." 
                 includes = 
                         "net/sf/colossus/parser/*.java,
                          **/*.sav"
                />
        </delete>
</target>


<target name="fix"
        description = "Fix end of line characters and eliminate tabs"> 
        <fixcrlf srcDir="." eol="lf" tab="remove" javafiles="yes" 
                eof="remove" tablength="8"
                includes="**/*.java,**/*.jj"
        />
</target>


<target name="run"
        description = "Run the game">
        <java jar="Colossus.jar"
              fork="yes"/>
</target>


<!-- Tools -->


<target name="tools" depends="bbjar,brjar"/>

<target name="bbjar" depends="init,compile,version"
        description = "Make Battlelands Builder jar file">
        <jar jarfile = "BattlelandsBuilder.jar" basedir="."
             manifest="META-INF/datatools/BattlelandsBuilder/MANIFEST.MF"
             includes="net/sf/colossus/datatools/*.class,
             net/sf/colossus/client/*.class,
             net/sf/colossus/parser/*.class,
             net/sf/colossus/server/*.class,
             net/sf/colossus/util/*.class,
             Default,
             TitanPlus,
             ExtTitan,
             Badlands,
             Sakis,
             Outlands"
        />
        <chmod file="BattlelandsBuilder.jar" perm="755"/>
</target>

<target name="brjar" depends="init,compile,version"
        description = "Make Battlelands Randomizer jar file">
        <jar jarfile = "BattlelandsRandomizer.jar" basedir="."
             manifest="META-INF/datatools/BattlelandsRandomizer/MANIFEST.MF"
             includes="net/sf/colossus/datatools/*.class,
             net/sf/colossus/client/*.class,
             net/sf/colossus/parser/*.class,
             net/sf/colossus/server/*.class,
             net/sf/colossus/util/*.class,
             Default,
             TitanPlus,
             ExtTitan,
             Badlands,
             Sakis,
             Outlands"
        />
        <chmod file="BattlelandsRandomizer.jar" perm="755"/>
</target>

<!-- TODO If jar is already signed, don't sign it again. -->
<target name="sign" depends="jar"
        description = "Sign jar file">
        <signjar jar="Colossus.jar"
                 alias="${user.name}"
                 keystore="${user.name}Keystore"
                 storepass="${env.JARPASSWORD}"
        />
        <chmod file="Colossus.jar" perm="755"/>
        <copy file="Colossus.jar" todir="test"/>
</target>



<!-- Tasks from here down are only needed for installation on the web site. -->

<!-- TODO Make a Windows version of this task. -->
<target name="changelog" depends=""
        description = "Create a ChangeLog file from cvs history">
        <exec executable="cvs2cl.pl" os="Linux,SunOS"> 
            <arg line="-S --no-wrap --utc"/>
        </exec>
        <delete verbose="yes" file = "ChangeLog.bak"/>
</target>

<target name="docs" depends=""
        description = "Generate docs from TeX source">
        <exec executable="make" dir="docs" os="Linux,SunOS">
            <arg line=""/>
        </exec>
</target>

<target name="dist" depends="init,sign,changelog,tools"
        description = "Make zip file for user download">
        <zip zipfile="${ZIPFILE}" basedir="."
             excludes="**/*.sav,
                 **/*.zip, 
                 **/*.bak, 
                 **/*javadoc*/*, 
                 *Keystore*,
                 *cfg,
                 *properties*,
                 BattlelandsBuilder.jar,
                 BattlelandsRandomizer.jar,
                 .*,
                 test/*.jar,
                 **/*.ps,
                 **/*.aux,
                 **/*.bbl,
                 **/*.bib,
                 **/*.blg,
                 **/*.log,
                 **/*.old"
        />
</target>


<target name="inst" depends="init,sign,dist,changelog,docs"
        description = "Copy files into htdocs tree on SF"> 
        <copy file="Colossus.jar" todir="${HTMLDIR}"/>
        <copy file="Colossus.jnlp" todir="${HTMLDIR}"/>
        <move file="${ZIPFILE}" todir="${DOWNLOAD_DIR}"/>
        <copy file="ChangeLog" todir="${HTMLDIR}"/>
        <copy todir="${DOCS_DIR}"> <fileset dir="docs"/>
</copy>


</target>


</project>
